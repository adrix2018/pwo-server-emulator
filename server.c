#include "misc.h"

bool decryptBuffer(uint8_t *buffer, uint32_t size);
bool analyzePacket(SOCKET s,uint8_t *buffer, uint32_t size);
uint8_t *generateRefPacket(uint8_t refValue);
uint8_t *generateConPacket();
void appendPacketEnding(uint8_t *buffer,uint32_t size);
uint8_t *generateCPackets();
void splitBuffer(uint8_t *buffer,uint32_t size);
 
PLAYER playerList;
int main(int argc , char *argv[])
{
	setbuf(stdout, NULL);
	
	
/*unsigned char hexData[249] = {
    0xFA, 0x89, 0x1E, 0xA3, 0xE6, 0x71, 0xE5, 0x71, 0x4E, 0x06, 0x79, 0xF1, 0x28, 0x7B, 0x23, 0x91,
    0x34, 0x72, 0xDD, 0xAC, 0x5A, 0xBA, 0x89, 0x2B, 0x59, 0xDB, 0x4B, 0x7D, 0xED, 0x48, 0x02, 0xBA,
    0x16, 0x48, 0x16, 0x61, 0xD5, 0x5F, 0xF8, 0x25, 0x4D, 0xF5, 0xA0, 0x47, 0x62, 0x32, 0x5A, 0x1D,
    0xE1, 0xE4, 0x87, 0x1C, 0xE7, 0x7E, 0xF3, 0xF4, 0x46, 0xDE, 0x00, 0x86, 0x79, 0xDC, 0xA3, 0x82,
    0x5A, 0x48, 0xCB, 0xE7, 0xC9, 0x81, 0xCC, 0xBD, 0xDC, 0x5B, 0x7C, 0x1B, 0x93, 0xAE, 0x4A, 0xFF,
    0x3A, 0x3A, 0xFB, 0xFD, 0x4E, 0xF1, 0x15, 0x87, 0xF7, 0xBA, 0x85, 0x7D, 0xBA, 0x84, 0x86, 0x15,
    0x33, 0xF9, 0xD2, 0xBD, 0x9C, 0xE2, 0xE6, 0x5A, 0x4C, 0x5A, 0xA4, 0xCA, 0x70, 0x84, 0x47, 0x89,
    0x9A, 0x97, 0x7D, 0x34, 0x68, 0x4C, 0x78, 0x1F, 0x55, 0x6D, 0xA1, 0xD9, 0x41, 0xB6, 0x7C, 0x2E,
    0x5C, 0x0D, 0x0A, 0xBB, 0xCC, 0x4C, 0xC4, 0xD9, 0x51, 0xED, 0x71, 0x47, 0x06, 0x71, 0xF1, 0x79,
    0x3A, 0x76, 0xDE, 0x6C, 0x34, 0xDE, 0x90, 0x31, 0xD5, 0xDA, 0x6D, 0x0B, 0xA6, 0x70, 0x5D, 0xE6,
    0x48, 0x0D, 0xAF, 0x0A, 0x58, 0x06, 0x34, 0x82, 0x03, 0xB0, 0x73, 0x0F, 0xDD, 0xB9, 0x0D, 0x7B,
    0x69, 0x03, 0x78, 0xA9, 0xB6, 0xD5, 0x13, 0xBA, 0x29, 0xB3, 0xA9, 0x7A, 0xE5, 0x6D, 0xD4, 0x2B,
    0xAA, 0xCA, 0xB0, 0x7A, 0x29, 0xC8, 0xA8, 0xEE, 0xB1, 0xD9, 0xA5, 0xD4, 0x47, 0x62, 0x0B, 0x83,
    0xE6, 0x0F, 0xA5, 0x59, 0x37, 0xA3, 0xA0, 0x4A, 0xE2, 0x09, 0x90, 0xDD, 0xD2, 0xC3, 0x31, 0xE4,
    0xDA, 0xF2, 0x32, 0x03, 0xE2, 0xCF, 0xB8, 0x9C, 0xEE, 0xE6, 0x13, 0x13, 0x05, 0xEC, 0x94, 0x3E,
    0xC8, 0x63, 0xDB, 0x9A, 0x7C, 0x2E, 0x5C, 0x0D, 0x0A 
};



int fdp = 0;
uint32_t sizee = 0;
uint8_t* sexyBufferr = hexData;

while(fdp < 249){
		
		if(!memcmp(&hexData[fdp], packetEnding, 5)){
			
			sexyBufferr += sizee;
			sizee = 1 + ((uint32_t)&hexData[fdp+4] - (uint32_t)(sexyBufferr));
			
			decryptBuffer(sexyBufferr, sizee);
			
			printf("FDP %d\n", fdp);
			int tmp2 = 0;
			while(tmp2 < sizee){
				printf("%c", sexyBufferr[tmp2++]);
			}
			
			printf("\n");
		}
		fdp++;
	}
	
	return 0;
	
	*/
    WSADATA wsa;
    SOCKET s, new_socket;
    struct sockaddr_in server, client;
	int c;
	
    printf("\nInitialising Winsock...");
    if (WSAStartup(MAKEWORD(2,2),&wsa) != 0)
    {
        printf("Failed. Error Code : %d",WSAGetLastError());
        return 1;
    }
     
    printf("Initialised.\n");
     
    //Create a socket
    if((s = socket(AF_INET , SOCK_STREAM , 0 )) == INVALID_SOCKET)
    {
        printf("Could not create socket : %d" , WSAGetLastError());
    }
 
    printf("Socket created.\n");
     
    //Prepare the sockaddr_in structure
    server.sin_family = AF_INET;
    server.sin_addr.s_addr = INADDR_ANY;
    server.sin_port = htons( 800 );
     
    //Bind
    if( bind(s ,(struct sockaddr *)&server , sizeof(server)) == SOCKET_ERROR)
    {
        printf("Bind failed with error code : %d" , WSAGetLastError());
    }
     
    puts("Bind done");
	
	

	memset(&playerList, 0 , sizeof(playerList));//Zeroes it
	if(!addPlayerToPlayerList(&playerList, "krystalgamer", "yomomma"))
		return 1;
	
	printPlayerList(&playerList);
	
	//Listen to incoming connections
    listen(s , 3);
     
    //Accept and incoming connection
    puts("Waiting for incoming connections...");
     
    c = sizeof(struct sockaddr_in);
	
	if( (new_socket = accept(s , (struct sockaddr *)&client, &c)) != INVALID_SOCKET ){
        puts("Connection accepted");
	}
    else{
        printf("accept failed with error code : %d" , WSAGetLastError());
        return 1;
    }
	
	//Comunication
	int iResult = 0;
	#define RECV_BUF_LEN 2048
	uint8_t recvbuf[RECV_BUF_LEN];
	
	 do {

        iResult = recv(new_socket, recvbuf, RECV_BUF_LEN, 0);
        if (iResult > 0) {
			//printf("Packet received, decrypting...\n");

			analyzePacket(new_socket, recvbuf, iResult);
			
			memset(recvbuf, 0, RECV_BUF_LEN);
        }
        else if (iResult == 0)
            printf("Connection closing...\n");
        else  {
          break;
        }

    } while (iResult > 0);

	
	
    closesocket(s);
    WSACleanup();
    return 0;
}


